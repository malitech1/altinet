{% extends "web/base.html" %}
{% load static %}

{% block title %}Altinet Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'web/css/home.css' %}" />
{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
<div class="row g-4 align-items-stretch home-layout">
  <div class="col-12 col-xl-4 col-xxl-3">
    <section
      class="environment-card bg-white border border-2 border-secondary-subtle rounded-4 shadow-sm h-100 p-3 p-lg-4"
      data-weather-endpoint="{{ weather_endpoint }}"
    >
      <div class="d-flex flex-column h-100">
        <header class="mb-4">
          <p class="text-uppercase text-primary fw-semibold small mb-1">Live environment</p>
          <h1 class="h4 fw-semibold mb-0">Your home at a glance</h1>
        </header>
        <div class="mb-4">
          <p id="local-time-display" class="display-6 fw-semibold mb-1">
            {{ environment_snapshot.local_time|date:"g:i A" }}
          </p>
          <p id="local-date-display" class="text-muted mb-0">
            {{ environment_snapshot.local_time|date:"l, F j" }}
          </p>
        </div>
        <div class="environment-metrics row row-cols-1 row-cols-sm-2 g-3">
          <div class="col">
            <article class="environment-metric h-100">
              <h2 class="h6 text-uppercase text-muted mb-2">People present</h2>
              <p class="metric-value mb-0">{{ environment_snapshot.people_present }}</p>
            </article>
          </div>
          <div class="col">
            <article class="environment-metric h-100">
              <h2 class="h6 text-uppercase text-muted mb-2">Occupants</h2>
              {% if environment_snapshot.people_list %}
                <ul class="metric-list mb-0">
                  {% for person in environment_snapshot.people_list %}
                    <li>{{ person }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="metric-placeholder mb-0">No occupants detected</p>
              {% endif %}
            </article>
          </div>
          <div class="col">
            <article class="environment-metric h-100">
              <h2 class="h6 text-uppercase text-muted mb-2">Outside temperature</h2>
              <p
                class="metric-value mb-0"
                data-weather-field="outside_temperature_c"
                data-weather-format="temperature"
              >
                {% if environment_snapshot.outside_temperature_c is not None %}
                  {{ environment_snapshot.outside_temperature_c|floatformat:1 }}°C
                {% else %}
                  —
                {% endif %}
              </p>
            </article>
          </div>
          <div class="col">
            <article class="environment-metric h-100">
              <h2 class="h6 text-uppercase text-muted mb-2">Average indoor temperature</h2>
              <p class="metric-value mb-0">
                {% if environment_snapshot.average_indoor_temperature_c is not None %}
                  {{ environment_snapshot.average_indoor_temperature_c|floatformat:1 }}°C
                {% else %}
                  —
                {% endif %}
              </p>
            </article>
          </div>
          <div class="col">
            <article class="environment-metric h-100">
              <h2 class="h6 text-uppercase text-muted mb-2">Wind</h2>
              <p class="metric-value mb-0">
                <span
                  data-weather-field="wind_speed_kmh"
                  data-weather-format="wind-speed"
                >
                  {% if environment_snapshot.wind_speed_kmh is not None %}
                    {{ environment_snapshot.wind_speed_kmh|floatformat:1 }} km/h
                  {% else %}
                    —
                  {% endif %}
                </span>
                <span
                  class="text-muted"
                  data-weather-field="wind_direction_cardinal"
                  data-weather-format="wind-direction"
                >
                  {% if environment_snapshot.wind_speed_kmh is not None and environment_snapshot.wind_direction_cardinal %}
                    ({{ environment_snapshot.wind_direction_cardinal }})
                  {% endif %}
                </span>
              </p>
            </article>
          </div>
          <div class="col">
            <article class="environment-metric h-100">
              <h2 class="h6 text-uppercase text-muted mb-2">Local weather</h2>
              <p
                class="metric-value mb-0"
                data-weather-field="weather_summary"
              >
                {{ environment_snapshot.weather_summary|default:"—" }}
              </p>
            </article>
          </div>
        </div>
        <div class="mt-4">
          <h2 class="h6 text-uppercase text-muted mb-3">Detailed outdoor weather</h2>
          <div class="table-responsive">
            <table class="table table-sm mb-2 environment-weather-table">
              <tbody>
                <tr>
                  <th scope="row" class="text-nowrap">Temperature</th>
                  <td
                    data-weather-field="outside_temperature_c"
                    data-weather-format="temperature"
                  >
                    —
                  </td>
                </tr>
                <tr>
                  <th scope="row" class="text-nowrap">Humidity</th>
                  <td data-weather-field="outside_humidity" data-weather-format="percentage">—</td>
                </tr>
                <tr>
                  <th scope="row" class="text-nowrap">Weather</th>
                  <td data-weather-field="weather_summary">—</td>
                </tr>
                <tr>
                  <th scope="row" class="text-nowrap">Wind speed</th>
                  <td data-weather-field="wind_speed_kmh" data-weather-format="wind-speed">—</td>
                </tr>
                <tr>
                  <th scope="row" class="text-nowrap">Wind direction</th>
                  <td data-weather-field="wind_direction_cardinal" data-weather-format="text">—</td>
                </tr>
                <tr>
                  <th scope="row" class="text-nowrap">Wind bearing</th>
                  <td data-weather-field="wind_direction_deg" data-weather-format="degrees">—</td>
                </tr>
                <tr>
                  <th scope="row" class="text-nowrap">Air quality</th>
                  <td data-weather-field="air_quality_index" data-weather-format="aqi">—</td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="text-muted small mb-0" data-weather-status>
            Gathering latest readings for Macleay Island&hellip;
          </p>
        </div>
      </div>
    </section>
  </div>
  <div class="col-12 col-xl-8 col-xxl-9">
    <div class="bg-white border border-2 border-secondary-subtle rounded-4 shadow-sm p-3 p-lg-4 h-100">
      <div
        id="home-viewer"
        class="viewer-shell rounded-4 border border-2 border-secondary-subtle position-relative overflow-hidden"
        data-obj-url="{% static 'web/models/home.obj' %}"
      >
        <div class="viewer-overlay d-flex flex-column align-items-center justify-content-center gap-2" data-role="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading 3D home model...</span>
          </div>
          <p class="text-muted small mb-0">Loading home model&hellip;</p>
        </div>
        <div class="viewer-overlay d-none text-center p-4" data-role="error">
          <h2 class="h5 fw-semibold mb-2">We couldn't load the home</h2>
          <p class="text-muted mb-0">
            Please refresh the page or check that your browser supports
            WebGL.
          </p>
        </div>
        <noscript>
          <div class="viewer-overlay d-flex flex-column align-items-center justify-content-center gap-2 text-center p-4">
            <h2 class="h5 fw-semibold mb-2">JavaScript required</h2>
            <p class="text-muted mb-0">
              Enable JavaScript to interact with the 3D overview of your home.
            </p>
          </div>
        </noscript>
      </div>
    </div>
  </div>
</div>
<div class="row mt-4">
  <div class="col-12">
    <section class="assistant-card bg-white border border-2 border-secondary-subtle rounded-4 shadow-sm p-3 p-lg-4">
      <header class="mb-3">
        <p class="text-uppercase text-primary fw-semibold small mb-1">Assistant</p>
        <h2 class="h4 fw-semibold mb-0">Ask Altinet anything</h2>
      </header>
      <div class="d-flex flex-column gap-4">
        <form data-llm-form class="d-flex flex-column gap-3">
          <div>
            <label class="form-label fw-semibold" for="assistant-prompt">Prompt</label>
            <textarea
              id="assistant-prompt"
              class="form-control"
              rows="3"
              placeholder="Ask about your environment, devices, or anything else."
              data-llm-input
            ></textarea>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-3">
            <button type="submit" class="btn btn-primary" data-llm-submit>Send to assistant</button>
            <p class="small text-muted mb-0" data-llm-status>Waiting for your question.</p>
          </div>
        </form>
        <section class="assistant-response" aria-live="polite" data-llm-response>
          The assistant's response will appear here.
        </section>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module" src="{% static 'web/js/home-viewer.js' %}"></script>
<script src="{% static 'web/js/home-llm.js' %}" defer></script>

<script type="module" src="{% static 'web/js/home-local-time.js' %}"></script>
<script type="module" src="{% static 'web/js/home-weather.js' %}"></script>
{% endblock %}
